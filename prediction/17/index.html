<!DOCTYPE html>
<html lang="en">

<head>

    <title>Tarot-o-bot</title>
    <meta name="description" content="In the future free Facebook <span style='color:#ffb422'>users</span> will be stuck in a <span style='color:#5226ef'>looped</span> timeline. Only premium ones will be able to scroll freely.">
    <meta property="og:locate" content="en_US" />
    <meta property="og:site_name" content="tarotobot.illo.tv" />
    <meta property="og:title" content="Tarot-o-bot" />
    <meta property="og:type" content="website" />
    <meta property="og:description" content="In the future free Facebook <span style='color:#ffb422'>users</span> will be stuck in a <span style='color:#5226ef'>looped</span> timeline. Only premium ones will be able to scroll freely." />
    <meta property="og:image" content="https://tarotobot.illo.tv/includes/images/OG/9.png" />
    <meta property="og:url" content="https://tarotobot.illo.tv/prediction/template/" />

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=1">

    <link rel="icon" href="../../includes/images/favicon.ico" type="image/x-icon">
    <link rel="icon" href="../../includes/images/favicon-32x32.png" type="image/png" sizes="32x32">
    <link rel="icon" href="../../includes/images/favicon-16x16.png" type="image/png" sizes="16x16">

    <link rel="stylesheet" type="text/css" href="../../includes/CSS/brillo7.css">
    <link rel="stylesheet" type="text/css" href="../../includes/CSS/cards.css">
    <link rel="stylesheet" type="text/css" href="../../includes/fonts/stylesheet.css">
    <style>
        /* å åœç»“æœå­—ä½“ç¨å°ï¼Œé€‚é…æ¡Œé¢ */
        #prediction_text {
            font-size: 1.2vw !important;
            line-height: 1.6 !important;
            max-width: 90%;
        }

        /* æ¡Œé¢ç«¯ï¼šä¿æŒåŸç‰ˆå¸ƒå±€ */
        @media (min-width: 1025px) {
            .card_video_container {
                display: flex;
                align-items: center;
                justify-content: center;
            }

            #text_info {
                max-width: 40%;
            }
        }

        /* å¹³æ¿å’Œæ‰‹æœºï¼šé‡æ’å¸ƒå±€ï¼Œé¿å…ç»å¯¹å®šä½å¯¼è‡´è¶…å‡ºå±å¹• */
        @media (max-width: 1024px) {
            body {
                overflow-y: auto;
            }

            .card_video_container {
                position: static !important;
                height: auto !important;
                line-height: normal !important;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: flex-start;
                padding: 80px 12px 40px;
                box-sizing: border-box;
            }

            .flip-card {
                width: 80vw !important;
                max-width: 280px;
                margin: 10px auto;
                display: block;
            }

            .card_video {
                width: 100% !important;
                height: auto !important;
            }

            #text_info {
                position: static !important;
                margin: 20px auto 0 !important;
                padding-top: 0 !important;
                margin-right: 0 !important;
                width: 100%;
                text-align: left;
                box-sizing: border-box;
                padding: 0 8px;
            }

            #prediction_text {
                font-size: 14px !important;
                max-width: 100%;
            }

            .tags_container {
                margin-top: 8px;
            }

            .tag {
                font-size: 12px !important;
                margin-bottom: 4px;
            }

            #buttons {
                margin-top: 10px;
            }

            .brillo_btn {
                width: 48% !important;
                font-size: 14px !important;
                height: 44px !important;
                line-height: 44px !important;
                margin-right: 2% !important;
                margin-bottom: 8px;
            }

            #subtitle_txt {
                position: static !important;
                margin-top: 10px;
                font-size: 13px !important;
                width: 100% !important;
                padding: 0 12px 20px;
                box-sizing: border-box;
            }

            #title_colored {
                width: 40vw;
                padding-top: 10px;
            }

            .icons {
                width: 50px;
            }
        }

        /* å°å±æ‰‹æœºè¿›ä¸€æ­¥æ”¶ç´§é—´è· */
        @media (max-width: 480px) {
            .card_video_container {
                padding-top: 70px;
            }

            .flip-card {
                width: 88vw !important;
            }

            .brillo_btn {
                width: 100% !important;
                margin-right: 0 !important;
            }

            #subtitle_txt {
                font-size: 12px !important;
            }
        }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

    <!-- Google Tag Manager -->
    <script>
        (function(w, d, s, l, i) {
            w[l] = w[l] || [];
            w[l].push({
                'gtm.start': new Date().getTime(),
                event: 'gtm.js'
            });
            var f = d.getElementsByTagName(s)[0],
                j = d.createElement(s),
                dl = l != 'dataLayer' ? '&l=' + l : '';
            j.async = true;
            j.src =
                'https://www.googletagmanager.com/gtm.js?id=' + i + dl;
            f.parentNode.insertBefore(j, f);
        })(window, document, 'script', 'dataLayer', 'GTM-MHMDVG6');
    </script>
    <!-- End Google Tag Manager -->
</head>


<body>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MHMDVG6" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->

    <div id="anim_container"></div>

    <div id="particles-js"></div>

    <div id="title_colored">
        <img src="../../includes/images/cards.gif" id="header_gif">
    </div>

    <div class="icons" id="left_up">
        <img src="../../includes/images/corners/icon1.gif" style="width: 100%;">
    </div>

    <div class="icons" id="left_bottom">
        <img src="../../includes/images/corners/icon2.gif" style="width: 100%;">
    </div>

    <div class="icons" id="right_up">
        <img src="../../includes/images/corners/icon3.gif" style="width: 100%;">
    </div>

    <div class="icons" id="right_bottom">
        <img src="../../includes/images/corners/icon4.gif" style="width: 100%;">
    </div>

    <div>
        <div class="main_content card_video_container">

            <div class="flip-card" id="card1">
                <div class="flip-card-inner">
                    <div class="flip-card-front">
                        <img src="../../includes/images/cards/back.png">
                    </div>
                    <div class="flip-card-back">
                        <video autoplay muted playsinline webkit-playsinline x5-playsinline loop
                               class="card_video" id="card1_video"
                               src="../../includes/videos/The Artificial Intelligence.mp4"
                               type="video/mp4"></video>
                    </div>
                </div>
            </div>

            <div class="flip-card" id="card2">
                <div class="flip-card-inner">
                    <div class="flip-card-front">
                        <img src="../../includes/images/cards/back.png">
                    </div>
                    <div class="flip-card-back">
                        <video autoplay muted playsinline webkit-playsinline x5-playsinline loop
                               class="card_video" id="card2_video"
                               src="../../includes/videos/The Update.mp4"
                               type="video/mp4"></video>
                    </div>
                </div>
            </div>

            <div class="flip-card" id="card3">
                <div class="flip-card-inner">
                    <div class="flip-card-front">
                        <img src="../../includes/images/cards/back.png">
                    </div>
                    <div class="flip-card-back">
                        <video autoplay muted playsinline webkit-playsinline x5-playsinline loop
                               class="card_video" id="card3_video"
                               src="../../includes/videos/The Patron.mp4"
                               type="video/mp4"></video>
                    </div>
                </div>
            </div>

            <div id="text_info">
                <div class="main_text" id="prediction_text" style="display: none; font-size: 1.2vw; line-height: 1.6;"></div>
                </br> </br>

                <div class="tags_container" id="tags_container" style="display: none;">
                    <div class="tag" id="tag1"></div>
                    <div class="tag" id="tag2"></div>
                    <div class="tag" id="tag3"></div>
                </div>

                </br></br>
                <div id="buttons" style="display: none;">
                    <div id="share_btn" class="brillo_btn" data-clipboard-action="copy">
                        Share it</br>
                        <img src="../../includes/images/arrow_down_black.png" class="btn_icon">
                    </div>

                    <div id="another_btn" class="brillo_btn">
                        Another one </br>
                        <img src="../../includes/images/arrow_left_black.png" class="btn_icon">
                    </div>

                    <div id="copy_btn" class="brillo_btn" style="display:none;">
                        Link copied</br>
                        <span id="text_to_copy" style="display:none"></span>
                        <span>Share it on your favorite social network</span>
                        <img src="../../includes/images/link.png" class="btn_icon">
                    </div>

                </div>

            </div>



        </div>
        <div id="subtitle_txt">Think deeply about the future and click on the cards.</div>
    </div>


</body>

<script>
    (function(i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r;
        i[r] = i[r] || function() {
            (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date();
        a = s.createElement(o),
            m = s.getElementsByTagName(o)[0];
        a.async = 1;
        a.src = g;
        m.parentNode.insertBefore(a, m)
    })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

    ga('create', 'UA-60264431-1', 'auto');
    ga('send', 'pageview');
</script>


<script src="../../includes/anims/lottie.js" type="text/javascript"></script>
<script src="../../includes/js/particles.min.js" type="text/javascript"></script>
<script src="../../includes/js/clipboard.min.js" type="text/javascript"></script>


<script type="text/javascript">
    $(document).ready(function() {

        // è¿è¡Œç‚¹å‡»è¿‡æ¸¡åŠ¨ç”»ï¼ˆç¼ºå°‘åŠ¨ç”»æ–‡ä»¶æ—¶å¿½ç•¥é”™è¯¯ï¼Œé¿å…é˜»å¡åç»­é€»è¾‘ï¼‰
        try {
            run_click_animation();
        } catch (e) {
            console.error("run_click_animation error:", e);
        }

        // ç»Ÿä¸€ä½¿ç”¨ç‚¹å‡»ç¿»ç‰Œé€»è¾‘ï¼Œé¿å…ç§»åŠ¨ç«¯è‡ªåŠ¨ç¿»ç‰Œå¯¼è‡´äº¤äº’å¤±æ•ˆ
        if (window.particlesJS && particlesJS.load) {
            particlesJS.load('particles-js', '../../includes/js/particles.json', function() {});
        }
        $(".flip-card-inner").on('click', flip);

        var clipboard = new ClipboardJS("#share_btn", {
            text: function() {
                var copyText = document.getElementById("text_to_copy");
                return copyText.textContent;
            }
        });

        clipboard.on('success', function(e) {
            console.log(e);
            $("#copy_btn").show();
            setTimeout(function() {
                $("#copy_btn").fadeOut("slow");
            }, 2000);
        });
        clipboard.on('error', function(e) {
            console.log(e);
        });

        function flip() {
            // åªåœ¨ç¬¬ä¸€æ¬¡ç‚¹å‡»æ—¶ç¿»é¢
            var currentTransform = $(this).css("transform");
            if (!currentTransform || currentTransform === 'none' || currentTransform === 'matrix(1, 0, 0, 1, 0, 0)') {
                $(this).css("transform", "rotateY(180deg)");

                // ç§»åŠ¨ç«¯æœ‰æ—¶ä¸ä¼šè‡ªåŠ¨æ’­æ”¾ï¼Œéœ€è¦åœ¨ç”¨æˆ·ç‚¹å‡»æ—¶æ‰‹åŠ¨ play ä¸€ä¸‹
                var cardId = $(this).closest('.flip-card').attr('id');
                if (cardId) {
                    var videoEl = document.getElementById(cardId + "_video");
                    if (videoEl) {
                        try {
                            var playPromise = videoEl.play();
                            if (playPromise && playPromise.catch) {
                                playPromise.catch(function (e) {
                                    console.warn("video play blocked:", e);
                                });
                            }
                        } catch (e) {
                            console.warn("video play error:", e);
                        }
                    }
                }
            }
            animation_done();
        }

        function flip_degree() {
            if ($(this).css("transform") == 'none') {
                $(this).css("transform", "rotateY(50deg)");
            } else {
                $(this).css("transform", "");
            }
        }

        // ä» localStorage è¯»å–ç”¨æˆ·æ•°æ®
        var userData = null;
        try {
            var stored = localStorage.getItem("tarotUserData");
            if (stored) {
                userData = JSON.parse(stored);
                // è°ƒè¯•ï¼šæ‰“å°è¯»å–çš„æ•°æ®
                console.log("è¯»å–çš„ç”¨æˆ·æ•°æ®:", userData);
            }
        } catch(e) {
            console.error("è¯»å–ç”¨æˆ·æ•°æ®å¤±è´¥:", e);
        }

        // å¦‚æœæ²¡æœ‰ç”¨æˆ·æ•°æ®ï¼Œè·³å›é¦–é¡µ
        if (!userData) {
            console.warn("æœªæ‰¾åˆ°ç”¨æˆ·æ•°æ®ï¼Œè·³å›é¦–é¡µ");
            window.location = "../../index.html";
        }

        function animation_done() {
            // æ‰€æœ‰å¡ç‰‡éƒ½ç¿»å¼€äº†ï¼Œè°ƒç”¨åç«¯ API è·å–å åœç»“æœ
            if ($(".flip-card-inner:eq(0)").css("transform") !== "none" && $(".flip-card-inner:eq(1)").css(
                    "transform") !== "none" && $(".flip-card-inner:eq(2)").css("transform") !== "none") {

                // è°ƒç”¨åç«¯ API
                var cards = userData.preparedCards.map(c => c.name_zh || c.name_en);
                if (cards.length === 0) {
                    cards = ["æœªçŸ¥", "æœªçŸ¥", "æœªçŸ¥"];
                }
                
                // è°ƒè¯•ï¼šæ‰“å°å‘é€ç»™åç«¯çš„æ•°æ®
                var requestData = {
                    name: userData.name,
                    birth_date: userData.birth,
                    question: userData.question,
                    cards: cards
                };
                console.log("å‘é€ç»™åç«¯çš„æ•°æ®:", requestData);
                
                fetch("/api/divine", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(requestData)
                })
                .then(res => {
                    // æ£€æŸ¥å“åº”çŠ¶æ€
                    if (!res.ok) {
                        return res.json().then(errData => {
                            throw new Error(errData.error || `HTTP ${res.status}: ${res.statusText}`);
                        });
                    }
                    return res.json();
                })
                .then(data => {
                    // æ˜¾ç¤ºå åœç»“æœ
                    var resultText = data.reply || "å åœç»“æœç”Ÿæˆä¸­...";
                    $("#prediction_text").html(resultText.replace(/\n/g, "<br>")).show();
                    
                    // æ˜¾ç¤ºæ ‡ç­¾ï¼ˆä½¿ç”¨ç‰Œåï¼‰
                    if (cards.length >= 3) {
                        $("#tag1").text("#" + cards[0]).show();
                        $("#tag2").text("#" + cards[1]).show();
                        $("#tag3").text("#" + cards[2]).show();
                    }
                    $("#tags_container").show();
                    $("#buttons").show();
                    
                    // æ›´æ–°åˆ†äº«æ–‡æœ¬
                    var shareText = "ğŸ”® " + resultText.substring(0, 100) + "...\n\nğŸŒ Try your fortune " + window.location.origin;
                    $("#text_to_copy").text(shareText);
                })
                .catch(err => {
                    console.error("è·å–å åœç»“æœå¤±è´¥:", err);
                    var errorMsg = err.message || "å åœç»“æœç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•";
                    $("#prediction_text").html("<span style='color: #ff6b6b;'>" + errorMsg + "</span>").show();
                    $("#tags_container").show();
                    $("#buttons").show();
                });

                // æ¡Œé¢ç«¯ä¿æŒåŸæ¥çš„å¡ç‰‡æ•£å¼€åŠ¨ç”»ï¼›ç§»åŠ¨ç«¯ç›´æ¥ä¿æŒç«–æ’å¸ƒå±€ï¼Œé¿å…ä¹±é£
                if (window.innerWidth > 1024) {
                    // if all cards are flipped move the cards after the last animation finishes
                    setTimeout(function () {
                        move_cards();
                    }, 2000);
                } else {
                    // ç§»åŠ¨ç«¯ï¼šéšè—æç¤ºï¼Œæ·¡å…¥ç»“æœå’ŒæŒ‰é’®ï¼Œä¸ç§»åŠ¨å¡ç‰‡
                    $("#subtitle_txt").hide();
                    setTimeout(function () {
                        $("#prediction_text").fadeIn("slow");
                    }, 500);
                    setTimeout(function () {
                        $("#tags_container").fadeIn("slow");
                    }, 1000);
                    setTimeout(function () {
                        $("#buttons").fadeIn("slow");
                    }, 1500);
                    // ç¦æ­¢ç»§ç»­ç‚¹å‡»å¡ç‰‡
                    $(".flip-card-inner").off('click');
                }

            } else {
                //console.log("animations not done");
            }
        }

        $(".flip-card-inner").mouseleave(function() {
            $(this).addClass("notAnimation");
        });

        function move_cards() {
            $(".flip-card-inner:eq(0)").css("transform", "");
            $(".flip-card-inner:eq(1)").css("transform", ""); // close all cards

            $(".flip-card-inner:eq(2)").animate({
                right: '20%'
            }, "1500");
            $(".flip-card-inner:eq(1)").animate({
                left: '105%',
                top: '1vw'
            }, "1500");
            $(".flip-card-inner:eq(0)").animate({
                left: '230%',
                top: '2vw'
            }, "1500");

            $(".flip-card-inner:eq(0)").removeClass("notAnimation");
            $(".flip-card-inner:eq(1)").removeClass("notAnimation");

            $("#subtitle_txt").hide();

            setTimeout(function() {
                $(".main_text").fadeIn("slow");
            }, 500);

            setTimeout(function() {
                $(".tags_container").fadeIn("slow");
            }, 1000);

            setTimeout(function() {
                $("#buttons").fadeIn("slow");
            }, 1500);

            $(".flip-card-inner").off('click'); //unbind previous click function
            $(".flip-card-inner").on('click', load_video); //bind it to the new function

        };

        function load_video() {

            var video = $(this).find('.card_video');
            console.log(video);
            $("#card3 video").attr("src", video.attr("src"));
        }


        function run_click_animation() {
            // æ£€æŸ¥ bodymovin å’Œå®¹å™¨æ˜¯å¦å­˜åœ¨
            if (typeof bodymovin === 'undefined' || !document.getElementById('anim_container')) {
                return;
            }

            var animData = {
                container: document.getElementById('anim_container'),
                renderer: 'svg',
                autoplay: true,
                loop: false,
                rendererSettings: {
                    preserveAspectRatio: 'xMidYMid slice'
                },
                path: '../../includes/anims/transition.json'
            };

            try {
                $("#anim_container").css("z-index", 2);
                var anim = bodymovin.loadAnimation(animData);
                if (anim && anim.addEventListener) {
                    anim.addEventListener('complete', hide_bodymovin);
                }
            } catch (e) {
                console.warn("åŠ¨ç”»åŠ è½½å¤±è´¥:", e);
                hide_bodymovin(); // ç›´æ¥éšè—å®¹å™¨
            }
        }

        function hide_bodymovin() {
            try {
                if (typeof bodymovin !== 'undefined') {
                    bodymovin.destroy();
                }
            } catch (e) {
                // å¿½ç•¥é”€æ¯é”™è¯¯
            }
            $("#anim_container").css("z-index", -1);
        }

        /*
        $("#share_btn").click(function () {
            $("#copy_btn").show();

            var copyText = document.getElementById("text_to_copy");
            var textArea = document.createElement("textarea");
            textArea.value = copyText.textContent;

            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand("Copy");
            textArea.remove();

            setTimeout(function () {
                $("#copy_btn").fadeOut("slow");
            }, 2000);
        });*/

        $("#share_btn").hover(function() {
            $(this).css("background-color", "black");
            $(this).css("color", "#FEB420");
            $(this).css({
                "border-color": "#FEB420",
                "border-width": "1px",
                "border-style": "solid"
            });
            $("#share_btn img").attr('src', "../../includes/images/arrow_down_yellow.png");
        }, function() {
            $(this).css("background-color", "#FEB420");
            $(this).css("color", "black");
            $("#share_btn img").attr('src', "../../includes/images/arrow_down_black.png");
        });

        function reset_draw_ui() {
            // å›åˆ°æŠ½å¡ç•Œé¢ï¼ˆä¸è·³è½¬ï¼‰ï¼šé‡ç½®å¡ç‰‡ã€éšè—ç»“æœã€é‡æ–°å…è®¸ç¿»ç‰Œ
            
            // éšè—ç»“æœå’ŒæŒ‰é’®
            $("#prediction_text").hide().html("");
            $("#tags_container").hide();
            $("#buttons").hide();
            $("#subtitle_txt").show();

            // å…ˆåœæ­¢æ‰€æœ‰åŠ¨ç”»
            $(".flip-card-inner").stop(true, false);
            $(".flip-card").stop(true, false);

            // æŠŠå¡ç‰‡åŠ¨ç”»å›åŸä½ï¼ˆæ’¤é”€ move_cards çš„æ•ˆæœï¼‰
            // æ³¨æ„ï¼šmove_cards ä¿®æ”¹çš„æ˜¯ flip-card-inner çš„ä½ç½®ï¼Œéœ€è¦é‡ç½®
            $(".flip-card-inner:eq(0)").animate({
                left: '0',
                top: '0'
            }, 800, function() {
                $(this).css("left", "").css("top", "").css("right", "");
            });
            
            $(".flip-card-inner:eq(1)").animate({
                left: '0',
                top: '0'
            }, 800, function() {
                $(this).css("left", "").css("top", "").css("right", "");
            });
            
            $(".flip-card-inner:eq(2)").animate({
                right: '0',
                top: '0'
            }, 800, function() {
                $(this).css("left", "").css("top", "").css("right", "");
            });

            // å»¶è¿Ÿä¸€ä¸‹å†ç¿»å›èƒŒé¢ï¼Œè®©ä½ç½®åŠ¨ç”»å…ˆå®Œæˆ
            setTimeout(function() {
                // ç¿»å›èƒŒé¢ï¼ˆé‡ç½® transformï¼‰
                $(".flip-card-inner").css("transform", "");
                $(".flip-card-front").show();
                
                // ç§»é™¤ notAnimation ç±»
                $(".flip-card-inner").removeClass("notAnimation");

                // æ¢å¤ç‚¹å‡»ç¿»ç‰Œäº‹ä»¶ï¼ˆç§»é™¤ load_videoï¼Œé‡æ–°ç»‘å®š flipï¼‰
                $(".flip-card-inner").off('click');
                $(".flip-card-inner").on('click', flip);
            }, 900);
        }

        $("#another_btn").click(function() {
            // æœ¬åœ°ç‰ˆæœ¬ï¼šè¿”å›æŠ½å¡ç•Œé¢ï¼ˆåŒé¡µé¢é‡ç½®ï¼‰
            reset_draw_ui();
            /*
            $.get("../../create.php", function (id) {
                if (id) {
                    var current_url = window.location.href;
                    var segements = current_url.split("/");
                    segements[segements.length - 2] = "" + id;
                    var newurl = segements.join("/");
                    window.location = newurl;

                } else {
                    console.log("There was a server side error");
                }
            });*/
        });

        $("#another_btn").hover(function() {
            $(this).css("background-color", "black");
            $(this).css("color", "white");
            $(this).css({
                "border-color": "white",
                "border-width": "1px",
                "border-style": "solid"
            });
            $("#another_btn img").attr('src', "../../includes/images/arrow_left_grey.png");
        }, function() {
            $(this).css("background-color", "white");
            $(this).css("color", "black");
            $("#another_btn img").attr('src', "../../includes/images/arrow_left_black.png");
        });

        $(".icons").click(function() {
            // æœ¬åœ°ç‰ˆæœ¬ï¼šè¿”å›æœ¬åœ°é¦–é¡µ
            window.location = "../../index.html";
        });

        $("#title_colored").click(function() {
            // æœ¬åœ°ç‰ˆæœ¬ï¼šè¿”å›æœ¬åœ°é¦–é¡µ
            window.location = "../../index.html";
        });

    });
</script>

</html>